version: '2.1'
jobs:
  build:
    docker:
      - image: circleci/openjdk:11.0
    working_directory: /tmp/workspace
    steps:
      - checkout
      - run: ./mvnw -s .circleci/settings.xml -Dmaven.repo.local=.m2 install
      - persist_to_workspace:
          root: /tmp/workspace
          paths: ['*', '**/*']

  sign:
    docker:
      - image: circleci/openjdk:11.0
    working_directory: /tmp/workspace
    steps:
      - attach_workspace:
          at: /tmp/workspace
      - run: sudo apt-get update
      - run: |
            echo 'Package: libassuan0' | sudo tee /etc/apt/preferences.d/libassuan0
            echo 'Pin: release n=stretch-backports' | sudo tee -a /etc/apt/preferences.d/libassuan0
            echo 'Pin-Priority: 1000' | sudo tee -a /etc/apt/preferences.d/libassuan0
      - run: sudo apt-get install gpg gpg-agent
      - run: echo "$GPG_SECRET_KEY" | base64 -d > /tmp/key
      - run: echo "$GPG_PASSPHRASE" | gpg --batch --yes --passphrase-fd 0 --import /tmp/key
      - run: rm /tmp/key
      - run: sudo ln -s $(which gpg) /usr/local/bin/gpg2
      - run: ./mvnw -s .circleci/settings.xml -Dmaven.repo.local=.m2 package gpg:sign
      - persist_to_workspace:
          root: /tmp/workspace
          paths: ['*', '**/*']

  publish:
    docker:
      - image: circleci/openjdk:11.0
    working_directory: /tmp/workspace
    steps:
      - attach_workspace:
          at: /tmp/workspace
      - run: sudo apt-get update
      - run: |
          echo 'Package: libassuan0' | sudo tee /etc/apt/preferences.d/libassuan0
          echo 'Pin: release n=stretch-backports' | sudo tee -a /etc/apt/preferences.d/libassuan0
          echo 'Pin-Priority: 1000' | sudo tee -a /etc/apt/preferences.d/libassuan0
      - run: sudo apt-get install gpg gpg-agent
      - run: echo "$GPG_SECRET_KEY" | base64 -d > /tmp/key
      - run: echo "$GPG_PASSPHRASE" | gpg --batch --yes --passphrase-fd 0 --import /tmp/key
      - run: rm /tmp/key
      - run: sudo ln -s $(which gpg) /usr/local/bin/gpg2
      - run: ./mvnw -s .circleci/settings.xml -Dmaven.repo.local=.m2 package gpg:sign
      - run: ./mvnw -s .circleci/settings.xml -Dmaven.repo.local=.m2 -pl '!src/validator' gpg:sign deploy

workflows:
  version: '2.1'
  default:
    jobs:
      - build:
          filters:
            tags:
              only: /.*/
      - publish:
          requires:
            - build
          context: bintray.com
          filters:
            branches:
              ignore: /.*/
            tags:
              only: /\d+\.\d+\.\d+/
